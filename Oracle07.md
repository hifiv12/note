18. 커서와 예외 처리
  - 커서
    * 커서
      - sql문을 실행했을 때 해당 sql문 처리 정보를 저장
      - select문의 결과 행 별로 특정 작업 수행
    * select into 방식
      - 조회되는 행이 하나 일 때
      - 커서는 조회되는 행의 수와 상관없이 사용
    * 명시적 커서
      - 직접 커서를 선언하고 사용

      단계 | 명칭 | 설명 
      -- | -- | --
      1단계 | 커서 선언(declaration) | 사용자가 직접 이름을 지정하여 사용할 커서를 SQL문과 함께 선언
      2단계 | 커서 열기(open) | 커서를 선언할 때 작성한 SQL문을 실행. 실행한 SQL문에 영향을 받는 행을 active set이라 부름
      3단계 | 커서에서 읽어온 데이터 사용(fetch) | 실행된 SQL문의 결과 행 정보를 하나씩 읽어 와서 변수에 저장한 후 필요한 작업을 수행. 각 행별로 공통 작업을 반복해서 실행하기 위해 여러 종류의 LOOP문을 함께 사용 가능
      4단계 | 커서 닫기(close) | 모든 행의 사용이 끝나고 커서를 종료

      - 정의
        ```sql
          declare
            cursor 커서이름 is sql문; -- 커서 선언
          begin
            open 커서이름;            -- 커서 열기
            fetch 커서이름 into 변수  -- 커서로부터 읽어온 데이터 사용
            close 커서이름;           -- 커서 닫기
          end;
        ```

        - 하나의 행만 조회되는 경우
        - 여러 행이 조회되는 경우
          * loop
          * for loop
            
            속성 | 설명
            -- | --
            커서이름%notfound | 수행된 fetch문을 통해 추출된 행이 있으면 false, 없으면 true
            커서이름%found | 수행된 fetch문을 통해 추출된 행이 있으면 true, 없으면 false
            커서이름%rowcount | 현재까지 추출된 행 수를 반환
            커서이름%isopen | 커서가열려 있으면 true, 닫혀 있으면 false
          
          * 커서에 파라미터 사용하기
    * 묵시적 커서
      - sql문을 사용했을 때 자동으로 선언되는 커서
      - open, fetch, close 지정 없음
          속성 | 설명
          -- | --
          sql%notfound | 묵시적 커서 안에 추출한 행이 있으면 false, 없으면 true. dml 명령어로 영향이 받는 행이 없을 경우에도 true 반환
          sql%found | 묵시적 커서 안에 추출한 행이 있으면 true, 없으면 false를 반환. dml명령어로 영향을 받는 행이 있다면 true를 반환
          sql%rowcount | 묵시적 커서에 현재까지 추출한 행 수 또는 dml 명령어로 영향 받는 행 수를 반환
          sql%isopen | 묵시적 커서는 자동으로 sql문을 실행한 후 close되므로 이 속성을 항상 false를 반환
  - 예외 처리
    * 오류
      - 컴파일 오류 혹은 문법 오류
      - 런타임 오류 혹은 실행 오류 : 예외
    * 예외 종류
      
      예외 종류 | 설명
      -- | --
      내부예외 - 사전 정의된 예외 | 내부 예외 중 예외번호에 해당하는 이름이 존재하는 예외
      내부예외 - 이름이 없는 예외 | 내부 예외 중 이름이 존재하지 않는 예외
      사용자 정의 예외 | 사용자가 필요에 따라 직접 정의한 예외
    * 예외 처리부 작성

      ```sql
        exception
          when 예외이름1 [or 예외이름2 - ] then
            예외처리명령어
          when 예외이름3 [or 예외이름4 - ] then
            예외처리명령어
          ...
          when others then
            예외처리명령어
      ```
      - 이름 없는 예외 처리
        
        ```sql
          declare
            예외이름1 exception;
            pragma exception_init(예외이름1, 예외번호);
          .
          .
          .
          exception
            when 예외이름1 then
              예외처리명령어
            ...
          end;
        ```
      - 사용자 정의 예외 사용
        
        ```sql
          declare
            사용자_예외_이름 exception;
            ...
          begin
            if 사용자_예외를_발생시킬_조건 then
              raise 사용자_예외_이름
            ...
            end if;
          exception
            when 사용자_예외_이름 then
              예외_처리에_사용할_명령어;
            ...
          end;
        ```
      - 오류 코드와 오류 메세지 사용

      함수 | 설명
      -- | --
      sqlcode | 오류 번호를 반환하는 함수
      sqlerrm | 오류 메세지를 반환하는 함수

19. 저장 서브 프로그램
  - 저장 서브 프로그램
    * 저장 서브프로그램 : 이름을 지정하여 저장해두는 PL/SQL 프로그램
      
      기능 | 익명 블록 | 저장 서브프로그램
      -- | -- | --
      이름 | 이름 없음 | 이름 지정
      오라클 저장 | 저장할 수 없음 | 저장함
      컴파일 | 실행할 때마다 컴파일 | 저장할 때 한 번 컴파일
      공유 | 공유 불가 | 공유하여 사용가능
      다른 응용프로그램에서의 호출가능 여부 | 호출할 수 없음 | 호출 가능

      서브 프로그램 | 용도
      저장 프로시저 | 일반적으로 특정 처리 작업 수행을 위한 서브프로그램으로 SQL문에서는 사용할 수 없음
      저장 함수 | 일반적으로 특정 연산을 거친 결과 값을 반환하는 서브 프로그램으로 SQL문에서 사용 가능
      패키지 | 저장 서브프로그램을 그룹화하는데 사용
      트리거 | 특정 상황(이벤트)이 발생할 때 자동으로 연달아 수행할 기능을 구현하는데 사용

  - 프로시저
    * 파라미터를 사용하지 않는 프로시저

      ```sql
        create [or replace] procedure 프로시저_이름
        is | as
          선언부
        begin
          실행부
        exception
          예외_처리부
        end [프로시저_이름];
      ```

    * 프로시저 내용 확인

      user_source의 열 | 설명
      -- |--
      name | 서브프로그램(생성 객체) 이름
      type | 서브프로그램 종류(procedure, function 등)
      line | 서브프로그램에 작성한 줄 번호
      text | 서브프로그램에 작성한 소스 코드

    * 프로시저 삭제하기
      - drop
    * 파라미터를 사용하는 프로시저

      ```sql
        create [or replace] procedure 프로시저_이름
        [(
          파라미터_이름1 [modes] 자료형 [ := | default 기본값],
          파라미터_이름2 [modes] 자료형 [ := | default 기본값],
          ...
          파라미터_이름n [modes] 자료형 [ := | default 기본값],
        )]
        is | as
          선언부
        begin
          실행부
        exception
          예외_처리부
        end [프로시저_이름];
      ```
    * 파라미터 사용 모드
      
      파라미터 모드 | 설명
      -- | --
      in | 지정하지 않으면 기본값으로 프로시저를 호출할 때 값을 입력
      out | 호출 할 때 값을 반환
      in out | 호출 할 때 값을 입력 -> 실행 결과 반환
    * 프로시저 오류 정보 확인하기
      - show errors
      - user_errors
  - 함수
    * 프로시저와 함수
      
      특징 | 프로시저 | 함수
      -- | -- | --
      실행 | execute 명령어 또는 다른 pl/sql 서브프로그램 내에서 호출하여 실행 | 변수를 사용한 execute 명령어 또는 다른 pl/sql 서브프로그램에서 호출하여 실행하거나 sql문에서 직접 실행 가능
      파라미터 지정 | 필요에 따라 지정하지 않을 수도 있고 여러 개 지정할 수도 있으며 in, out, in out 세가지 모드를 사용 | 프로시저와 같게 지정하지 않을 수도 있고 여러개 지정할 수 있지만 in모드(또는 생략)만 사용
      값의 반환 | 실행 후 값의 반환이 없을 수도 있고 out, in out 모드으 ㅣ파라미터 수에 따라 여러 개 값을 반환할 수 있음 | 반드시 하나의 값을 반환해야 하며 값의 반환은 프로시저와 달리 out, in out모드의 파라미터를 사용하는 것이 아니라 return절과  return문을 통해 반환

    * 함수 생성하기
       ```sql
        create [or replace] function 함수_이름
        [(
          파라미터_이름1 [in] 자료형1, 
          파라미터_이름2 [in] 자료형2,
          ...
          파라미터_이름1 [in] 자료형1 

        )]
        return 자료형
        is | as
          선언부
        begin
          실행부
          return (반환 값);
        exception
          예외_처리부
        end [함수_이름];
      ```
    * 함수 실행하기
      - pl/sql로 함수 실행하기
      - sql문에서 함수 실행하기
    * 함수 삭제하기
      - drop
  - 패키지
    * 패키지 
      - 여러 서브프로그램을 통합/관리
      - 모듈성, 설계, 정보 은닉, 기능성 및 성능 향상
    * 패키지 구조와 생성
      - 명세
      - 본문
      - 패키지 명세

        ```sql
          create [or replace] package 패키지_이름
          is | as
            서브프로그램을_포함한_다양한_객체_선언
          end [패키지 이름];
        ```

      - 패키지 본문

        ```sql
          create [or replace] package 패키지_이름
          is | as
            패키지_명세에서_선언한_서브프로그램을_포함한_여러_객체를_정의
            경우에_따라_패키지_명세에_존재하지_않는_객체_및_서브프로그램도_정의_가능
          end [패키지 이름];
        ```
      
      - 서브프로그램 오버로드

        ```sql
          create [or replace] package 패키지_이름
          is | as
            서브프로그램_종류 서브프로그램_이름(파라미터정의);
            서브프로그램_종류 서브프로그램_이름(개수나 자료형, 순서가 다른 파라미터 정의);
          end [패키지 이름];
        ```
      
      - 패키지 사용
        * 패키지이름.객체이름
      - 패키지 삭제
        * drop
  - 트리거
    * 트리거
      - 데이터베이스 내 이벤트 발생시 자동 실행될 기능을 정의
      - 트리거 사용의 장점 
        * 간편한 데이터 작업
        * 복잡한 데이터 규칙 정의
        * 보안성, 안정성을 위한 대처 활용
      - 트리거 지정 대상
      - 트리거의 구분
    * DML 트리거
      
      ```sql
        create [or replace] trigger 트리거_이름
        before | after
        insert | update | delete on 테이블_이름
        Referencing OLD as old | New as new
        for each row when 조건식
        follows 트리거_이름2, 트리거_이름3 ...
        enable | disable

        declare
          선언부
        begin
          실행부
        exception
          예외 처리부
        end;
      ```

    * DML 트리거 제작 및 사용
      - before
      - after
    * 트리거 정보 조회
      - user_triggers
    * 트리거 변경
      - alter
    * 트리거 삭제
      - drop




-----------------------------------------------------------------
cursor
  특정 위치를 가르키는 것

PL/SQL 의 cursor
  select한 결과에서 특정행을 가리키는 객체
  -> 서버측 커서

자바에서는 ResultSet Class가 cursor 역할을 담당
  -> 클라이언트측 커서 or 응용프로그램 측 커서

입출력 (Input/Output) - i/o
  1.open
  2.사용
  3.close
  ex 파일입출력, db입출력, 네트워크입출력

cursor는 close하면 fetch를 더이상 할 수 없음
다시 open하면 fetch가 가능함

----------------------------------------------------------------------

exception
  실행 중(run time)이 발생하는 에러
  ->application이 종료됨
  ->c언어 등의 언어에서는 개발자가 runtime 에러를 예측해서 직접 처리했어야 함

java 에서 exception 처리는 exception이 발생하더라도 appliacation이 종료되지
않게 하는 것이 주 목적
  -> 자바의 주요 특징 중 하나
  -> 많은 다른 언어들에 영향을 줌
  -> exception이 발생하면 log를 text파일이나 db에 저장해서 주기적으로 분석,
  application 유지보수에 참고

고가용성(High Availability)

Java + Oracle : 오랜기간 Enterprise시장을 점유
  -> 최근 대체제가 많이 생기면서 도전에 직면

JSP MVC => Spring Framework =>

전자정부프레임워크
  -> 정부에 발주하는 공공프로젝트에는 반드시 전자정부프레임워크를 사용해야됨

세전 - 1억
세후 - 1억

-----------------------------------------------------------------------

Trigger
  어떤 테이블에서 insert, update, delete등이 일어날 때 자동으로 호출되는 프로시져
  
  1.trigger는 transaction 처리가 자동
  -> commit, rollback 이 자동으로 처리됨
  2.trigger를 너무 많이 사용하거나, trigger 내부에서 transaction 처리가 늦어지면 시스템에 안좋다
  3.trigger 안에서 처리는 짧은시간에 끝나도록 처리

----------------------------------------------------------------------
Trigger에서 for each row 사용
  :old -> 삭제되거나 수정되기전 row에 대한 정보 잠시 보관 
  :new -> 입력되거나 수정된 row에 대한 정보 잠시 보관

트리거를 발생시키는 전제조건(event) insert, update, delete가 발생하면
:old, :new에 데이터가 트리거에 종료될 때 까지 보관됨

:old -> 변경 전 데이터, delete, update시 수정 전 데이터
:new -> 변경 후 데이터 insert, update시 수정 후 데이터

일종의 history기능

-------------------------------------------------------------------------

log(로그)란?
  서버에서 발생한 일을 기록으로 남기는 것

  1.error log - 에러기록
  2.db log - db에 일어난 작업을 오라클에서 직접기록
  3.session log - 사용자가 작업한 내용을 기록 

크래거(cracker)가 웹서버에 접속하면
접속ip, 접속시간 등에 log에 기록됨

LTS(Long Term Support)
  오랜기간 유지보수를 해주기로 결정한 버전
  -> 안정적인 버전, 실무프로젝트에 적용추천

JAVA version 8, 11, 17

------------------------------------------------------------------------


